# Usage: helm upgrade --install dockey ./helm/dockey -n dockey -f values.yaml

global:
  namespace: dockey
  imageRegistry: dockey.azurecr.io
  imagePullPolicy: Always
  storageClass: managed-csi
  # CRITICAL: Forces Java to use less RAM and release it back to the OS
  javaOpts: "-XX:+UseSerialGC -Xss256k -XX:MaxRAMPercentage=75.0 -Djava.security.egd=file:/dev/./urandom"

services:
  comments:
    enabled: true
    image:
      repository: comments-service
      tag: latest
    replicas: 1
    port: 8082
    resources:
      requests:
        memory: "128Mi"
        cpu: "50m"
      limits:
        memory: "350Mi" # Minimum viability for Spring Boot
        cpu: "500m"     # Allow CPU burst during startup
    env:
      JAVA_TOOL_OPTIONS: ${{ .Values.global.javaOpts }}
      mongodbDatabase: "commentsdb"
      kafkaBootstrapServers: "kafka:9092"
      keycloakAuthServerUrl: "http://keycloak:8080"
      keycloakRealm: "dockey"
    healthCheck:
      liveness:
        initialDelaySeconds: 180
        periodSeconds: 30
        timeoutSeconds: 30
        failureThreshold: 5
      readiness:
        initialDelaySeconds: 60
        periodSeconds: 15
        timeoutSeconds: 20
        failureThreshold: 5

  docs:
    enabled: true
    image:
      repository: docs-service
      tag: latest
    replicas: 1
    port: 8080
    resources:
      requests:
        memory: "128Mi"
        cpu: "50m"
      limits:
        memory: "350Mi"
        cpu: "500m"
    env:
      JAVA_TOOL_OPTIONS: ${{ .Values.global.javaOpts }}
      databaseName: "docsdb"
      kafkaBootstrapServers: "kafka:9092"
      kafkaConsumerGroupId: "docs-service-group"
    healthCheck:
      liveness:
        initialDelaySeconds: 180
        periodSeconds: 30
        timeoutSeconds: 30
        failureThreshold: 5
      readiness:
        initialDelaySeconds: 60
        periodSeconds: 15
        timeoutSeconds: 20
        failureThreshold: 5

  user:
    enabled: true
    image:
      repository: user-service
      tag: latest
    replicas: 1
    port: 8081
    resources:
      requests:
        memory: "128Mi"
        cpu: "50m"
      limits:
        memory: "350Mi"
        cpu: "500m"
    env:
      JAVA_TOOL_OPTIONS: ${{ .Values.global.javaOpts }}
      databaseName: "usersdb"
      keycloakAuthServerUrl: "http://keycloak:8080"
      keycloakRealm: "dockey"
      kafkaBootstrapServers: "kafka:9092"
      kafkaConsumerGroupId: "user-service-group"
    healthCheck:
      liveness:
        initialDelaySeconds: 180
        periodSeconds: 30
        timeoutSeconds: 30
        failureThreshold: 5
      readiness:
        initialDelaySeconds: 60
        periodSeconds: 15
        timeoutSeconds: 20
        failureThreshold: 5

  frontend:
    enabled: true
    image:
      repository: frontend
      tag: latest
    replicas: 2  # Can scale horizontally
    port: 80
    resources:
      requests:
        memory: "32Mi"  # Nginx is very light
        cpu: "10m"
      limits:
        memory: "64Mi"
        cpu: "100m"
    env:
      # Not used at runtime (baked into build), but documented here
      VITE_USER_SERVICE_URL: "/api/users"
      VITE_DOCS_SERVICE_URL: "/api/docs"
      VITE_COMMENTS_SERVICE_URL: "/api/comments"
    healthCheck:
      liveness:
        initialDelaySeconds: 60
        periodSeconds: 30
        timeoutSeconds: 10
        failureThreshold: 5
      readiness:
        initialDelaySeconds: 30
        periodSeconds: 10
        timeoutSeconds: 5
        failureThreshold: 5

databases:
  postgres:
    # Kept separate as requested
    docs:
      enabled: true
      image:
        repository: postgres
        tag: "15-alpine"
      database: "docsdb"
      storage:
        size: "2Gi"
      resources:
        requests:
          memory: "64Mi"
          cpu: "50m"
        limits:
          memory: "256Mi" # Slightly increased to prevent OOM under load
          cpu: "200m"

    users:
      enabled: true
      image:
        repository: postgres
        tag: "15-alpine"
      database: "usersdb"
      storage:
        size: "2Gi"
      resources:
        requests:
          memory: "64Mi"
          cpu: "50m"
        limits:
          memory: "256Mi"
          cpu: "200m"

    keycloak:
      enabled: true
      image:
        repository: postgres
        tag: "15-alpine"
      database: "keycloak"
      storage:
        size: "2Gi"
      resources:
        requests:
          memory: "64Mi"
          cpu: "50m"
        limits:
          memory: "256Mi"
          cpu: "200m"

  mongodb:
    comments:
      enabled: true
      image:
        repository: mongo
        tag: "7.0"
      database: "commentsdb"
      storage:
        size: "10Gi"
      resources:
        requests:
          memory: "512Mi"
          cpu: "100m"
        limits:
          memory: "1Gi"
          cpu: "500m"

messaging:
  zookeeper:
    enabled: true
    image:
      repository: confluentinc/cp-zookeeper
      tag: "7.5.0"
    storage:
      data:
        size: "1Gi"
      logs:
        size: "512Mi"
    env:
      KAFKA_HEAP_OPTS: "-Xmx128M -Xms128M"
    resources:
      requests:
        memory: "128Mi"
        cpu: "50m"
      limits:
        memory: "256Mi"
        cpu: "200m"

  kafka:
    enabled: true
    image:
      repository: confluentinc/cp-kafka
      tag: "7.5.0"
    storage:
      size: "2Gi"
    env:
      KAFKA_HEAP_OPTS: "-Xmx256M -Xms256M"
      KAFKA_BROKER_ID: "1"
      KAFKA_ZOOKEEPER_CONNECT: "zookeeper:2181"
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: "PLAINTEXT:PLAINTEXT,PLAINTEXT_INTERNAL:PLAINTEXT"
      KAFKA_ADVERTISED_LISTENERS: "PLAINTEXT://kafka:9092,PLAINTEXT_INTERNAL://localhost:29092"
      KAFKA_LISTENERS: "PLAINTEXT://0.0.0.0:9092,PLAINTEXT_INTERNAL://0.0.0.0:29092"
      KAFKA_INTER_BROKER_LISTENER_NAME: "PLAINTEXT_INTERNAL"
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: "1"
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: "1"
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: "1"
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: "0"
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
    resources:
      requests:
        memory: "300Mi"
        cpu: "100m"
      limits:
        memory: "600Mi" # Kafka needs headroom or it will crash violently
        cpu: "500m"
    healthCheck:
      liveness:
        initialDelaySeconds: 120
        periodSeconds: 30

auth:
  keycloak:
    enabled: true
    image:
      repository: quay.io/keycloak/keycloak
      tag: "23.0"
    replicas: 1
    port: 8080
    command: ["start-dev"]
    resources:
      requests:
        memory: "256Mi"
        cpu: "200m"
      limits:
        memory: "600Mi" # Keycloak is heavy
        cpu: "500m"
    extraEnvVars:
      - name: JAVA_OPTS_APPEND
        value: "-XX:+UseSerialGC -Xms256m -Xmx400m -Djava.net.preferIPv4Stack=true"
    healthCheck:
      liveness:
        initialDelaySeconds: 180
        periodSeconds: 30

# Disable Prometheus for now to save ~100-200Mi RAM
monitoring:
  prometheus:
    enabled: false
    image:
      repository: prom/prometheus
      tag: latest
    storage:
      size: "2Gi"
    resources:
      requests:
        memory: "64Mi"
        cpu: "50m"
      limits:
        memory: "128Mi"
        cpu: "100m"
